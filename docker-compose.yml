version: '3.8'

services:
  redis:
    # Redis - Message queue for event processing
    image: redis:7-alpine
    container_name: claudehome_redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - claudehome_net

  # Privacy Filter - Anonymizes data before external processing
  privacy_filter:
    build: ./services/privacy_filter
    container_name: claudehome_privacy_filter
    restart: unless-stopped
    ports:
      - "8001:8001"
    volumes:
      - ./.claude/skills:/opt/claudehome/.claude/skills:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - claudehome_net

  # Event Ingester - Monitors HA for state changes
  event_ingester:
    build: ./services/event_ingester
    container_name: claudehome_event_ingester
    restart: unless-stopped
    ports:
      - "8002:8002"
    environment:
      - HA_CONFIG_DIR=/config
      - REDIS_URL=redis://redis:6379
      - POLL_INTERVAL=1.0
      - REDIS_URL=redis://redis:6379
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN}
      - MARIADB_HOST=${MARIADB_HOST}
      - MARIADB_PORT=${MARIADB_PORT}
      - MARIADB_USER=${MARIADB_USER}
      - MARIADB_PASSWORD=${MARIADB_PASSWORD}
      - MARIADB_DATABASE=${MARIADB_DATABASE}
      - MQTT_BROKER=${MQTT_BROKER}
      - MQTT_PORT=${MQTT_PORT}
      - MQTT_USER=${MQTT_USER}
      - MQTT_PASSWORD=${MQTT_PASSWORD}
      - DB_POLL_INTERVAL=${DB_POLL_INTERVAL:-30.0}
    volumes:
      - /media/pi/NextCloud/homeassistant:/config:ro
    depends_on:
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - claudehome_net

  # Health Monitor - Watches logs and sends alerts
  health_monitor:
    build: ./services/health_monitor
    container_name: claudehome_health_monitor
    restart: unless-stopped
    ports:
      - "8003:8003"
    environment:
      # - HA_CONFIG_DIR=/config
      # - HA_CONFIG_DIR=/media/pi/NextCloud/homeassistant
      - HA_CONFIG_DIR=${HA_CONFIG_DIR}
      - DISCORD_WEBHOOK=${DISCORD_WEBHOOK:-}
      - CHECK_INTERVAL=10.0
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - SSH_HOST=${SSH_HOST}
      - SSH_PORT=${SSH_PORT:-22}
      - SSH_USER=${SSH_USER:-root}
      - SSH_KEY_PATH=/app/.ssh/ha_key
    volumes:
      - /media/pi/NextCloud/homeassistant:/config:ro
      - ./ssh_key:/app/.ssh/ha_key:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8003/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - claudehome_net

  # Orchestrator - Main coordination service
  orchestrator:
    build: ./services/orchestrator
    container_name: claudehome_orchestrator
    restart: unless-stopped
    ports:
      - "8010:8000"
    environment:
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - REDIS_URL=redis://redis:6379
      - PRIVACY_FILTER_URL=http://privacy_filter:8001
      - HEALTH_MONITOR_URL=http://health_monitor:8003
      - EVENT_INGESTER_URL=http://event_ingester:8002
      - CLAUDE_MODEL=claude-sonnet-4-20250514
      - BATCH_SIZE=10
      - BATCH_WAIT_SECONDS=5.0
    depends_on:
      redis:
        condition: service_healthy
      privacy_filter:
        condition: service_started
      event_ingester:
        condition: service_started
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - claudehome_net

  triage_engine:
    build: ./services/triage_engine
    environment:
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-20250514}
    ports:
      - "8011:8000"
    depends_on:
      - redis
    restart: unless-stopped
    container_name: claudehome_triage_engine
    networks:
    - claudehome_net

  proactive_engine:
    build: ./services/proactive_engine
    environment:
      - REDIS_URL=redis://redis:6379
      - LLM_SERVICE_URL=http://llm_service:8000
      # - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      # - CLAUDE_MODEL=${CLAUDE_MODEL:-claude-sonnet-4-20250514}
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN}
    ports:
      - "8012:8000"
    depends_on:
      - redis
      - triage_engine
    restart: unless-stopped
    container_name: claudehome_proactive_engine
    networks:
      - claudehome_net

  anomaly_detector:
    container_name: claudehome_anomaly_detector
    build: ./services/anomaly_detector
    environment:
      - REDIS_URL=redis://redis:6379
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - CLAUDE_MODEL=claude-sonnet-4-20250514
    ports:
      - "8013:8000"
    depends_on:
      - redis
      - triage_engine
    networks:
      - claudehome_net
    restart: unless-stopped

  discord_bot:
    container_name: claudehome_discord_bot
    build: ./services/discord_bot
    environment:
      - REDIS_URL=redis://redis:6379
      - DISCORD_TOKEN=${DISCORD_TOKEN}
      - DISCORD_GUILD_ID=${DISCORD_GUILD_ID}
      - ORCHESTRATOR_URL=http://orchestrator:8000
      - PROACTIVE_ENGINE_URL=http://proactive_engine:8000
      - ANOMALY_DETECTOR_URL=http://anomaly_detector:8000
    depends_on:
      - redis
      - orchestrator
      - proactive_engine
      - anomaly_detector
    networks:
      - claudehome_net
    restart: unless-stopped

  automation_deployer:
    container_name: claudehome_automation_deployer
    # build: ./services/automation_deployer
    build:
      context: .
      dockerfile: services/automation_deployer/Dockerfile
    environment:
      - REDIS_URL=redis://redis:6379
      - HEALTH_MONITOR_URL=http://health_monitor:8003
      - HOME_ASSISTANT_URL=${HOME_ASSISTANT_URL}
      - HOME_ASSISTANT_TOKEN=${HOME_ASSISTANT_TOKEN}
      - HA_CONFIG_DIR=${HA_CONFIG_DIR}
      - OUTCOME_MONITOR_URL=http://outcome_monitor:8000
    ports:
      - "8014:8000"
    depends_on:
      - redis
      - health_monitor
    networks:
      - claudehome_net
    restart: unless-stopped

  context_builder:
    container_name: claudehome_context_builder
    build: ./services/context_builder
    environment:
      - REDIS_URL=redis://redis:6379
      - HEALTH_MONITOR_URL=http://health_monitor:8003
      - HA_CONFIG_DIR=${HA_CONFIG_DIR}
      - CONTEXT_REFRESH_INTERVAL=900
    ports:
      - "8015:8000"
    depends_on:
      - redis
      - health_monitor
    networks:
      - claudehome_net
    restart: unless-stopped

  llm_service:
    container_name: claudehome_llm_service
    build: ./services/llm_service
    environment:
      - LLM_PROVIDER=${LLM_PROVIDER}
      - LITELLM_URL=${LITELLM_URL}
      - LITELLM_MODEL=${LITELLM_MODEL}
      - LITELLM_API_KEY=${LITELLM_API_KEY}
      - OLLAMA_URL=${OLLAMA_URL}
      - OLLAMA_MODEL=${OLLAMA_MODEL}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY}
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    ports:
      - "8016:8000"
    networks:
      - claudehome_net
    restart: unless-stopped

  outcome_monitor:
    container_name: claudehome_outcome_monitor
    build: ./services/outcome_monitor
    environment:
      - REDIS_URL=redis://redis:6379
      - CONTEXT_BUILDER_URL=http://context_builder:8000
      - LLM_SERVICE_URL=http://llm_service:8000
      - MONITORING_DURATION_HOURS=48
    ports:
      - "8017:8000"
    depends_on:
      - redis
      - llm_service
      - context_builder
    networks:
      - claudehome_net
    restart: unless-stopped

  override_detector:
    container_name: claudehome_override_detector
    build: ./services/override_detector
    environment:
      - REDIS_URL=redis://redis:6379
      - LLM_SERVICE_URL=http://llm_service:8000
      - OVERRIDE_WINDOW_SECONDS=60
      - MIN_OVERRIDES_FOR_RULE=3
    ports:
      - "8018:8000"
    depends_on:
      - redis
      - llm_service
    networks:
      - claudehome_net
    restart: unless-stopped

volumes:
  redis_data:
    driver: local

networks:
  claudehome_net:
    driver: bridge
